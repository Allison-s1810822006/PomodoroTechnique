import SwiftUI

// ÊêóËõãÊ®°ÂºèÊûöËàâ
enum MischievousMode: String, CaseIterable {
    case sleeping = "sleeping"
    case coffee = "coffee"
    case vase = "vase"
    case documents = "documents"
    case furniture = "furniture"
    case clothes = "clothes"
    case screen = "screen"
    
    var displayName: String {
        switch self {
        case .sleeping: return "Ë≤ìÂí™Ê≠£Âú®ÂëºÂöï..."
        case .coffee: return "ÂºÑÂÄíÂíñÂï°ÊùØ"
        case .vase: return "ÊâìÁ†¥Ëä±Áì∂"
        case .documents: return "ÂºÑ‰∫ÇÊñá‰ª∂"
        case .furniture: return "ÊäìÂ£ûÂÆ∂ÂÖ∑"
        case .clothes: return "Âí¨Â£ûË°£Êúç"
        case .screen: return "Âí¨Â£ûËû¢Âπï"
        }
    }
    
    var iconName: String {
        switch self {
        case .sleeping: return "cat.fill"
        case .coffee: return "cup.and.saucer.fill"
        case .vase: return "party.popper.fill"
        case .documents: return "doc.fill"
        case .furniture: return "sofa.fill"
        case .clothes: return "tshirt.fill"
        case .screen: return "display"
        }
    }
}

struct ContentView: View {
    @State private var isRunning = false
    @State private var isShowingTaskSheet = false
    @State private var isShowingModeSheet = false
    @State private var selectedHour = 0
    @State private var selectedMinute = 25
    @State private var selectedSecond = 0
    @State private var timeRemaining = 0000 // È†êË®≠25ÂàÜÈêò (25*60=1500Áßí)
    @State private var timer: Timer?
    @State private var currentTask = "" // Áï∂Ââç‰ªªÂãô
    @State private var currentMode: MischievousMode = .sleeping // Áï∂ÂâçÊê£ËõãÊ®°Âºè
    
    // Ë®àÁÆóÈ°ØÁ§∫ÊôÇÈñìÁöÑÊ†ºÂºèÂåñÂ≠ó‰∏≤
    var timeDisplay: String {
        let hours = timeRemaining / 3600
        let minutes = (timeRemaining % 3600) / 60
        let seconds = timeRemaining % 60
        
        if hours > 0 {
            return String(format: "%02d:%02d:%02d", hours, minutes, seconds)
        } else {
            return String(format: "%02d:%02d", minutes, seconds)
        }
    }
    
    // Ë®àÁÆóÁ∏ΩË®≠ÂÆöÊôÇÈñìÔºàÁßíÔºâ
    var totalTime: Int {
        selectedHour * 3600 + selectedMinute * 60 + selectedSecond
    }
    
    var body: some View {
        VStack(spacing: 30) {
            // ÁãÄÊÖãÊåâÈàï - ÂèØ‰ª•ÈÅ∏ÊìáÊêóËõãÊ®°Âºè
            Button {
                isShowingModeSheet = true
            } label: {
                Text("ÁãÄÊÖãÔºö\(currentMode.displayName) > ")
                    .font(.system(size: 24, weight: .bold, design: .default))
            }
            
            // Ë≤ìÂí™ÂúñÁâá - Ê†πÊìöÈÅ∏ÊìáÁöÑÊ®°ÂºèÈ°ØÁ§∫
            VStack {
                Image(systemName: currentMode.iconName)
                    .font(.system(size: 88))
                    .foregroundColor(.black)
                    .padding()
            }
            
            // ÊôÇÈñìÈ°ØÁ§∫
            Text(timeDisplay)
                .font(.system(size: 48, weight: .bold, design: .monospaced))
                .foregroundColor(isRunning ? .primary : .gray)
                .padding()
                .background(Color.white.opacity(0.2))
                .cornerRadius(24)
            
            // Êñ∞Â¢ûÂ∞àÊ≥®‰ªªÂãôÊåâÈàï - Âè™Âú®ÈùûÈÅãË°åÁãÄÊÖãÈ°ØÁ§∫
            if !isRunning {
                Button {
                    isShowingTaskSheet = true
                } label: {
                    Text("Êñ∞Â¢ûÂ∞àÊ≥®‰ªªÂãô")
                        .font(.system(size: 18, weight: .medium))
                        .foregroundColor(.blue)
                        .padding(.horizontal, 20)
                        .padding(.vertical, 10)
                        .background(
                            RoundedRectangle(cornerRadius: 20)
                                .stroke(Color.blue, lineWidth: 1)
                        )
                }
            }
            
            // Áï∂Ââç‰ªªÂãôÈ°ØÁ§∫ - Âè™Âú®Êúâ‰ªªÂãôÊôÇÈ°ØÁ§∫
            if !currentTask.isEmpty {
                VStack {
                    Text("Áï∂Ââç‰ªªÂãô")
                        .font(.title3)
                        .foregroundColor(.secondary)
                        .padding()
                    Text(currentTask)
                        .font(.system(size: 18, weight: .medium))
                        .foregroundColor(.primary)
                        .multilineTextAlignment(.center)
                        .padding(.horizontal)
                }
            }
            
            // ÁãÄÊÖãÊñáÂ≠ó - Âè™Âú®Êúâ‰ªªÂãô‰∏îÊúâÊôÇÈñìÊôÇÈ°ØÁ§∫
            if !currentTask.isEmpty && timeRemaining > 0 {
                Text(isRunning ? "Â∞àÊ≥®‰∏≠..." : "Ê∫ñÂÇôÈñãÂßã")
                    .font(.system(size: 22, design: .default))
                    .foregroundColor(.secondary)
                    .padding()
            } else if timeRemaining == 0 && !currentTask.isEmpty {
                Text("ÊôÇÈñìÂà∞ÔºÅ")
                    .font(.system(size: 22, design: .default))
                    .foregroundColor(.red)
                    .padding()
            }
            
            // ÈñãÂßã/Êö´ÂÅúÊåâÈàï - Ê∞∏ÈÅ†È°ØÁ§∫
            Button(action: {
                if isRunning {
                    pauseTimer()
                } else {
                    startTimer()
                }
            }) {
                Text(isRunning ? "Êö´ÂÅú" : "ÈñãÂßã")
                    .font(.title)
                    .foregroundColor(.white)
                    .frame(width: 100, height: 22)
                    .padding()
                    .background(isRunning ? .orange : .green)
                    .cornerRadius(36)
            }
            .disabled((timeRemaining == 0 && !isRunning) || currentTask.isEmpty)
            
            // ÈáçÁΩÆÊåâÈàï - Âè™Âú®Êúâ‰ªªÂãôÊôÇÈ°ØÁ§∫
            if !currentTask.isEmpty {
                Button("ÈáçÁΩÆ") {
                    resetTimer()
                }
                .foregroundColor(.red)
                .padding(.top, 10)
            }
        }
        .padding()
        .sheet(isPresented: $isShowingTaskSheet) {
            TaskCreationSheet(
                selectedHour: $selectedHour,
                selectedMinute: $selectedMinute,
                selectedSecond: $selectedSecond,
                currentTask: $currentTask,
                onComplete: {
                    timeRemaining = totalTime
                    isShowingTaskSheet = false
                }
            )
        }
        .sheet(isPresented: $isShowingModeSheet) {
            MischievousModeSheet(
                currentMode: $currentMode,
                onComplete: {
                    isShowingModeSheet = false
                }
            )
        }
        .onDisappear {
            timer?.invalidate()
        }
    }
    
    // ÈñãÂßãË®àÊôÇÂô®
    func startTimer() {
        guard timeRemaining > 0 else { return }
        
        isRunning = true
        timer = Timer.scheduledTimer(withTimeInterval: 1.0, repeats: true) { _ in
            if timeRemaining > 0 {
                timeRemaining -= 1
            } else {
                // ÊôÇÈñìÂà∞‰∫Ü
                pauseTimer()
                // ÈÄôË£°ÂèØ‰ª•Âä†ÂÖ•ÈÄöÁü•ÊàñÈü≥Êïà
            }
        }
    }
    
    // Êö´ÂÅúË®àÊôÇÂô®
    func pauseTimer() {
        isRunning = false
        timer?.invalidate()
        timer = nil
    }
    
    // ÈáçÁΩÆË®àÊôÇÂô®
    func resetTimer() {
        pauseTimer()
        timeRemaining = totalTime
    }
}

// ÊêóËõãÊ®°ÂºèÈÅ∏ÊìáÁöÑ Sheet È†ÅÈù¢
struct MischievousModeSheet: View {
    @Binding var currentMode: MischievousMode
    let onComplete: () -> Void
    
    let columns = [
        GridItem(.flexible()),
        GridItem(.flexible())
    ]
    
    var body: some View {
        NavigationView {
            VStack(spacing: 20) {
                Text("ÈÅ∏ÊìáÊêóËõãÊ®°ÂºèüíÄ")
                    .font(.title2)
                    .fontWeight(.bold)
                    .padding(.top)
                
                Text("ÈÅ∏ÊìáË≤ìÂí™ÁöÑÊêóËõãË°åÁÇ∫")
                    .font(.headline)
                    .foregroundColor(.secondary)
                    .padding(.bottom)
                
                LazyVGrid(columns: columns, spacing: 20) {
                    ForEach(MischievousMode.allCases.dropFirst(), id: \.self) { mode in
                        Button {
                            currentMode = mode
                        } label: {
                            VStack(spacing: 12) {
                                Image(systemName: mode.iconName)
                                    .font(.system(size: 40))
                                    .foregroundColor(currentMode == mode ? .white : .primary)
                                
                                Text(mode.displayName)
                                    .font(.system(size: 14, weight: .medium))
                                    .foregroundColor(currentMode == mode ? .white : .primary)
                                    .multilineTextAlignment(.center)
                            }
                            .frame(width: 120, height: 100)
                            .background(
                                RoundedRectangle(cornerRadius: 15)
                                    .fill(currentMode == mode ? Color.blue : Color.gray.opacity(0.1))
                            )
                            .overlay(
                                RoundedRectangle(cornerRadius: 15)
                                    .stroke(currentMode == mode ? Color.blue : Color.gray.opacity(0.3), lineWidth: 2)
                            )
                        }
                        .buttonStyle(PlainButtonStyle())
                    }
                }
                .padding(.horizontal)
                
                Spacer()
            }
            .navigationTitle("")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("ÂèñÊ∂à") {
                        onComplete()
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("ÂÆåÊàê") {
                        onComplete()
                    }
                    .fontWeight(.bold)
                }
            }
        }
        .presentationDetents([.medium, .large])
        .presentationDragIndicator(.visible)
    }
}

// ‰ªªÂãôÂâµÂª∫ÁöÑ Sheet È†ÅÈù¢
struct TaskCreationSheet: View {
    @Binding var selectedHour: Int
    @Binding var selectedMinute: Int
    @Binding var selectedSecond: Int
    @Binding var currentTask: String
    let onComplete: () -> Void
    
    @State private var taskInput = ""
    @FocusState private var isTextFieldFocused: Bool
    
    var body: some View {
        NavigationView {
            VStack(spacing: 20) {
                
                // ‰ªªÂãôËº∏ÂÖ•ÂçÄÂüü
                VStack(alignment: .leading, spacing: 8) {
                    Text("Â∞àÊ≥®È†ÖÁõÆ")
                        .font(.headline)
                        .foregroundColor(.primary)
                    
                    TextField("Ëº∏ÂÖ•Ë¶ÅÂ∞àÊ≥®ÁöÑÈ†ÖÁõÆ...", text: $taskInput)
                        .textFieldStyle(.roundedBorder)
                        .focused($isTextFieldFocused)
                        .onAppear {
                            taskInput = currentTask.isEmpty ? "" : currentTask
                        }
                }
                .padding(.horizontal)
                
                // ÊôÇÈñìË®≠ÂÆöÂçÄÂüü
                VStack(spacing: 10) {
                    Text("Ë®≠ÂÆöÂ∞àÊ≥®ÊôÇÈñì")
                        .font(.headline)
                        .foregroundColor(.primary)
                    
                    HStack(spacing: 0) {
                        // Â∞èÊôÇÈÅ∏ÊìáÂô®
                        VStack {
                            Text("Â∞èÊôÇ")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            Picker("Â∞èÊôÇ", selection: $selectedHour) {
                                ForEach(0..<24) { hour in
                                    Text("\(hour)")
                                        .tag(hour)
                                }
                            }
                            .pickerStyle(.wheel)
                            .frame(width: 80)
                        }
                        
                        // ÂàÜÈêòÈÅ∏ÊìáÂô®
                        VStack {
                            Text("ÂàÜÈêò")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            Picker("ÂàÜÈêò", selection: $selectedMinute) {
                                ForEach(0..<60) { minute in
                                    Text("\(minute)")
                                        .tag(minute)
                                }
                            }
                            .pickerStyle(.wheel)
                            .frame(width: 80)
                        }
                        
                        // ÁßíÊï∏ÈÅ∏ÊìáÂô®
                        VStack {
                            Text("ÁßíÊï∏")
                                .font(.caption)
                                .foregroundColor(.secondary)
                            Picker("ÁßíÊï∏", selection: $selectedSecond) {
                                ForEach(0..<60) { second in
                                    Text("\(second)")
                                        .tag(second)
                                }
                            }
                            .pickerStyle(.wheel)
                            .frame(width: 80)
                        }
                    }
                    .padding(.horizontal)
                }
                
                // Âø´ÈÄüË®≠ÂÆöÊåâÈàï
                VStack(spacing: 10) {
                    Text("Âø´ÈÄüË®≠ÂÆöÊôÇÈñì")
                        .font(.headline)
                        .foregroundColor(.primary)
                    
                    HStack(spacing: 15) {
                        Button("25ÂàÜÈêò") {
                            selectedHour = 0
                            selectedMinute = 25
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                        
                        Button("15ÂàÜÈêò") {
                            selectedHour = 0
                            selectedMinute = 15
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                        
                        Button("5ÂàÜÈêò") {
                            selectedHour = 0
                            selectedMinute = 5
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                    }
                    
                    HStack(spacing: 15) {
                        Button("45ÂàÜÈêò") {
                            selectedHour = 0
                            selectedMinute = 45
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                        
                        Button("1Â∞èÊôÇ") {
                            selectedHour = 1
                            selectedMinute = 0
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                        
                        Button("2Â∞èÊôÇ") {
                            selectedHour = 2
                            selectedMinute = 0
                            selectedSecond = 0
                        }
                        .buttonStyle(.bordered)
                    }
                }
                .padding(.horizontal)
                
                Spacer()
            }
            .navigationTitle("Êñ∞Â¢ûÂ∞àÊ≥®‰ªªÂãô")
            .navigationBarTitleDisplayMode(.inline)
            .toolbar {
                ToolbarItem(placement: .navigationBarLeading) {
                    Button("ÂèñÊ∂à") {
                        onComplete()
                    }
                }
                
                ToolbarItem(placement: .navigationBarTrailing) {
                    Button("ÂÆåÊàê") {
                        // Êõ¥Êñ∞‰ªªÂãôÂêçÁ®±
                        if !taskInput.trimmingCharacters(in: .whitespacesAndNewlines).isEmpty {
                            currentTask = taskInput.trimmingCharacters(in: .whitespacesAndNewlines)
                        } else {
                            currentTask = "Â∞àÊ≥®‰ªªÂãô"
                        }
                        onComplete()
                    }
                    .fontWeight(.bold)
                }
                
                // ÈçµÁõ§ÂÆåÊàêÊåâÈàï
                ToolbarItemGroup(placement: .keyboard) {
                    Spacer()
                    Button("ÂÆåÊàê") {
                        isTextFieldFocused = false
                    }
                }
            }
        }
        .presentationDetents([.large])
        .presentationDragIndicator(.visible)
    }
}

#Preview {
    ContentView()
}
